## ICU 风险预测训练方案（LLM 弱标注 + 时序模型）

### 1. 概览

- **目标**：基于 `database/icu_patients/*.json` 的事件时序数据，利用 LLM 进行事件级弱标注，构建“多风险状态概率（state probability）曲线”的训练集，训练一个可输出校准概率的时序模型，用于提前识别风险并提供趋势信号。
- **核心思路**：
  - LLM 作为“教师”在事件级识别“present/active”与“resolved/ruled_out”等证据，推导每个风险的最早“起始时间（onset_ts）”与“解除时间（off_ts，可为空）”。
  - 采用“状态概率软标签”：在 `t=onset_ts` 处令 `y=1`；当 `t<onset_ts` 时按与 onset 的时间距离向前单调衰减；当 `onset_ts<t<off_ts` 时按与 onset 的时间距离向后单调衰减直至 `t=off_ts` 为 0；若 `t≥off_ts`（或未见风险）则为 0。
  - 训练“学生模型”（时序预测模型）在不调用 LLM 的情况下，在线给出各风险的当前状态概率，并与数值稳定化和告警策略衔接。

### 2. 标签定义与层级

- **风险词表**：使用 `database/icu_knowledge/risks_table.json` 作为标准风险层级（系统→类别→具体项）。标注与训练阶段均使用该词表中的“规范名称”，避免同义词漂移。
- **事件级存在标签（LLM 弱标注产物）**：
  - 对每个事件 `e=(patient_id, event_id, timestamp, event_type, sub_type, event_content)`，从 `risks_table.json` 中选择“当前事件已明确存在”的风险集合 `R_present(e)`。
  - 输出结构包含：`[{risk_path, confidence, rationale_en, evidence_event_ids}]`。`risk_path` 建议采用“层级路径字符串”，如 `呼吸系统/氧合/通气衰竭/急性低氧性呼吸衰竭`。
  - 规则：当某风险被标注为存在（present）时，默认在后续时间维持“已存在”状态，直至出现明确“解除/恢复/排除”等相反证据（resolved/ruled_out）。
**onset/off 定义**：某风险 `r` 的最早 present 时间记为 `onset_ts[r]`；若存在明确相反证据，则其最早时间记为 `off_ts[r]`（若未检出则 `off_ts[r]=None`），要求 `off_ts[r] > onset_ts[r]`。
**状态概率标签（本方案）**：在时间点 `t`（序列中的一个事件时间），对每个风险 `r` 定义 `y_r^state(t) ∈ [0,1]`：
  - 若 `t ≤ onset_ts[r]`：`y = s_back(Δ)`，其中 `Δ = onset_ts[r] - t`，且 `s_back(0)=1`，随 `Δ` 增大单调递减至 0；
  - 若 `onset_ts[r] < t < off_ts[r]`：`y = s_forward(Δ)`，其中 `Δ = t - onset_ts[r]`，`s_forward(0)=1`，并满足当 `t→off_ts[r]` 时 `y→0`；
  - 若 `t ≥ off_ts[r]` 或该风险从未出现：`y = 0`。
  - 推荐函数：线性（`s_back(Δ)=max(1-Δ/H_back,0)`；`s_forward(Δ)=max(1-Δ/(off_ts-onset_ts),0)`）或指数（`s(Δ)=exp(-Δ/τ)`；无 `off_ts` 时可用固定 `τ_fwd` 近似）。

### 3. LLM 事件级弱标注流水线

- **3.1 标注范围与调度（以 3.4 的全量子类型清单为准）**：
  - 范围：仅对 3.4 列出的“白/灰/黑名单”中的白名单（W）与在触发条件下的灰名单（G）事件送审；黑名单（B）默认跳过。
  - 语义：W=确诊入口/高置信 present；G=条件触发送审；B=跳过。
  - 调度：
    - 优先级：W > 触发后的 G；
    - 节流：按患者限定速率与批次（如每 10 分钟至多 N 条）；
    - 时间邻近补全：当某风险已在近 6–24h 内出现强证据，可扩展少量相邻 G 事件做链条补全（防漏）。
- **3.2 提示词与输出（严格 JSON）**：
  - System：
    - 角色：ICU 风险标注助手；仅使用给定事件文本与风险词表；输出严格 JSON；解释与日志使用英文短句；引用 `event_id`。
    - 约束：仅从给定词表选择；避免过度推断；若不确定则不标注为 present（可入 `uncertain` 以供复核）。
  - User：
    - 输入：当前 `event` 的字段、近 6–24h 的 TopK 证据摘要（仅 `event_id+一句话`），`risks_table.json` 展开后的平面清单（或具体分支）。
  - 输出 JSON（示例 schema）：
    ```json
    {
      "event_id": "...",
      "present": [
        {"risk_path": "呼吸系统/下呼吸道感染/重症肺炎", "confidence": "high", "evidence_event_ids": ["e_prev1"], "rationale": "..."}
      ],
      "uncertain": [
        {"risk_path": "循环系统/休克与灌注不良/脓毒性休克", "confidence": "low", "evidence_event_ids": ["e_prev2"], "rationale": "..."}
      ]
    }
    ```
- **3.3 汇总与 QC**：
  - 按 `risk_path` 聚合，取“最早 present 出现”的时间为 onset_ts；
  - 去除明显冲突（例如同一时间点标注多个不相容条目）；
  - 采样 5–10% 事件给医生复核，形成纠正集；
  - 对反复“不确定”的分支可引入二次判定 prompt 或专家复核优先队列（主动学习）。

#### 3.4 全量 sub_type 判定清单（权威版，基于 icu_patients 抽样，偏召回）

说明：覆盖 `subtypes_stats.json` 中 33 个子类型，按 W/G/B 分类（W=确诊入口；G=条件触发送审；B=跳过）。这是标注范围与调度的唯一依据，取代旧版 3.1 预筛选描述。

- 护理措施 → B
- order → G（关键干预触发：升压药/CRRT/血制品/气道管理/再插管/急诊手术）
- 一般护理监测记录单 → G（持续异常生命体征+装置/用药互证）
- 药物执行 → G（升压、CRRT、广谱抗菌、镇静泵入、胰岛素等显著调整）
- 导管观察及护理记录 → G（气管插管/再插管/气切；CAUTI 可疑；异常引流）
- 谵妄评估单 → G（RASS≥-3 且 CAM-ICU 阳性）
- history → W（明确诊断/术前后诊断/医师结论）
- 约束护理记录单 → B
- lab → W（电解质/酸碱/乳酸/AKI 阈；DIC 组合判读；CRP/PCT 不单独确诊）
- blood_gas → W（呼吸衰竭/酸碱紊乱阈；轻度异常→G）
- exam → W（影像/检查结论直接对应风险）
- 医院获得性肺炎风险因素评估表 → B
- Caprini血栓风险评估单 → B
- 疼痛评估及记录单 → B
- 导尿管伴随性尿路感染风险监控 → G（评分高+感染链证）
- Braden → B
- 皮肤观察及护理记录单 → G（出现“压力性损伤/分期/部位/面积”等明确描述时）
- 跌倒/坠床风险评估表 → B
- 压力性损伤观察及护理记录单 → G（分期/部位/面积/转归）
- Barthel指数量表 → B
- 内科血栓风险评估表 → B
- 重症疼痛观察量表CPOT → B
- 改良早期预警评分表MEWS → G（高危且与装置/用药互证）
- 住院病人昏迷评定记录单 → G（GCS≤8 持续且有他证）
- 危重护理记录单 → G（同“一般护理监测记录单”逻辑）
- surgery → W（术中所见/术后诊断）
- 肌力等级评估表 → B
- 洼田饮水试验及护理记录单 → G（误吸/吞咽失败/禁食鼻饲）
- 约束评估记录单 → B
- PICC穿刺记录单 → B
- PICC宣教记录单 → B
- 孕产妇VTE管理评估表 → B
- PICC导管维护记录单 → B

#### 3.5 标注执行 Flow（端到端）

1) 子类型调度：读取 3.4 权威清单 → 过滤出当前批次的 W 与满足触发条件的 G；B 跳过。
2) Prompt 组装：按 3.2 生成 System/User 提示，输入当前事件与近 6–24h TopK 证据摘要、`risks_table.json` 平面清单/分支。
3) 调用与节流：按患者批次/时间窗限速，失败重试；异常时降级为仅 W。
4) 解析与落盘：接收严格 JSON，写入 `present/uncertain`；记录 `event_id/evidence_event_ids/rationale/confidence`。
5) 汇总与 QC：按 3.3 生成 onset_ts，做冲突消解与抽样医师复核；输出问题清单做二次判定。

补充：
- off_ts 推导与质量控制：基于“解除/恢复/排除/好转”等文本证据、检查/化验数值回归与装置撤除等综合线索确定 `off_ts`；若无明确证据，可采用启发式“静默窗口”策略（如近 48–72h 无支持 present 的证据且生命体征回稳）作为候选，并标注较低置信度供复核。

#### 3.6 产出到训练样本的映射

将 per-event 的 `present/解除` 聚合为每个风险的 `onset_ts/off_ts`，并按 2. 的状态概率定义在各时间点 `t` 构造 `y_r^state(t)` 软标签；未出现 `onset_ts` 或 `t ≥ off_ts` 的时刻标签为 0。生成的样本在 4. 节进入特征工程与数据切分。

#### 3.7 全量 sub_type 判定清单（基于 icu_patients 抽样与描述，偏召回）

说明：以下覆盖 `subtypes_stats.json` 中的全部 33 个子类型。分类含义——白名单（W：确诊入口/高置信 present）、灰名单（G：条件触发送审）、黑名单（B：默认跳过）。为“宁多选也不少选”，边界项尽量收在 G，并给出触发条件。抽样来自多名患者文件，结合 `sub_type_descriptions.json` 与实际 `event_content` 片段核验。

- 护理措施 → B
  - 仅记录护理动作/体位/泵速等，不构成确诊；作为上下文证据。

- order → G
  - 触发：升压药/CRRT/血制品/气道管理/再插管/禁食+急诊手术等关键干预；用于审查“休克/AKI/呼吸衰竭/大出血”等风险。

- 一般护理监测记录单 → G
  - 触发：持续低血压/高乳酸/尿量骤降/持续低氧或高碳酸性并与装置/用药记录互证。

- 药物执行 → G
  - 触发：升压药剂量显著上调、CRRT 抗凝/透析液、抗凝/广谱抗生素切换、镇静持续泵入、胰岛素等矫治药物显著调整。

- 导管观察及护理记录 → G
  - 触发：气管插管/再插管/气切（呼吸衰竭/拔管失败）；导尿+感染征象（CAUTI 可疑）；引流液异常（血性/脓性）。

- 谵妄评估单 → W*（条件白）
  - 条件：RASS ≥ -3 且 CAM-ICU 阳性时确诊“谵妄”；若仅 RASS 异常（如深镇静 -4/-5）→ G（需他证）。

- history → W
  - 明确“入院/术前/术后诊断”“医师结论/评估印象”等确诊用语时，作为 present 入口；“鉴别/考虑/可能”→ uncertain。

- 约束护理记录单 → B
  - 非诊断类；仅行为/安全管理记录。可作上下文。

- lab → W（条件阈）
  - 电解质紊乱（K/Na/Ca/Mg/磷）按阈直接确诊；
  - 酸碱/代谢（代谢性酸中毒/碱中毒、乳酸性酸中毒）按组合阈；
  - AKI 参考肌酐上升/尿量下降（鼓励结合时间趋势）→ W；
  - DIC/重度凝血异常需多指标组合，由 LLM 判读；
  - 不以 CRP/PCT 单次升高直接确诊“脓毒症/感染性休克”。

- blood_gas → W（条件阈）
  - 急性低氧/高碳酸性呼吸衰竭、呼吸性酸/碱中毒按 pH/PaO2/PaCO2/HCO3- 阈组合确诊；轻度异常→ G。

- exam → W
  - 影像/检查“结论/所见”直接对应风险（如消化道穿孔、肠梗阻、DVT、脑出血、ARDS 征象、张力性气胸等）。

- 医院获得性肺炎风险因素评估表 → B
  - 风险评估而非确诊。

- Caprini血栓风险评估单 → B
  - 风险评估而非确诊。

- 疼痛评估及记录单 → B
  - 症状评分，非确诊入口。

- 导尿管伴随性尿路感染风险监控 → G
  - 触发：评分高+发热/脓尿/培养/抗生素调整等，审查 CAUTI/泌尿系感染。

- Braden → B
  - 压疮风险评估，非确诊。

- 皮肤观察及护理记录单 → G
  - 条件：文本含“压力性损伤/分期/部位/面积”等明确描述时送审；否则跳过。

- 跌倒/坠床风险评估表 → B
  - 风险评估；与本版风险词表不直接对应确诊。

- 压力性损伤观察及护理记录单 → W
  - 明确“分期/部位/面积/转归”等要素，作为“压力性损伤”确诊入口。

- Barthel指数量表 → B
  - 功能评估，非确诊入口。

- 内科血栓风险评估表 → B
  - 风险评估，非确诊。

- 重症疼痛观察量表CPOT → B
  - 痛觉行为评估，非确诊入口。

- 改良早期预警评分表MEWS → G
  - 触发：评分达高危并与生命体征/用药/装置互证，送审“休克/恶化”。

- 住院病人昏迷评定记录单 → G
  - 条件：GCS ≤ 8 持续且伴气道管理/影像/history 证据时送审“昏迷/意识障碍”。

- 危重护理记录单 → G
  - 与“一般护理监测记录单”同理；持续异常生命体征+装置/用药证据时送审。

- surgery → W
  - 术中所见/术后诊断可直接确诊相关风险（穿孔/血胸/脓胸/肠坏死等）。

- 肌力等级评估表 → B
  - 功能评估，非确诊入口。

- 洼田饮水试验及护理记录单 → G
  - 条件：明确“误吸/呛咳/吞咽失败”或需禁食/鼻饲干预时，送审“误吸/吸入性肺炎”。

- 约束评估记录单 → B
  - 安全/行为评估，非确诊入口。

- PICC穿刺记录单 → B
  - 操作记录，非确诊入口。

- PICC宣教记录单 → B
  - 宣教记录，非确诊入口。

- 孕产妇VTE管理评估表 → B
  - 风险评估，非确诊。

- PICC导管维护记录单 → B
  - 维护记录，非确诊入口。

### 4. 数据集构建（训练样本）

- **4.1 样本时刻与上下文**：
  - 样本时刻 `t` 取自患者事件时间（不均匀步长）；
  - 每个样本聚合“至多过去 W 小时（如 48–72h）的事件窗口”，并保留真实时间间隔（Δt）用于建模；
  - 输出每个风险的“状态概率软标签” `y_r^state(t)`（依据 `onset_ts/off_ts` 与衰减函数计算）。
- **4.2 特征工程**：
  - 文本特征：对 `event_content` 使用现有向量（如 `text-embedding-3-large`，可重用 `ScalableMemory`），并追加类型标签前缀 `[event_type/sub_type]` 以增强可分性；可对 TopK 事件做 attention 池化。
  - 结构化要素（已废弃）：
    - `lab`：解析项目与数值，标准化（z-score/单位统一），提取“异常”标志（↑/↓/阳性/阴性）与变化率；
    - `order`：药物/干预类别（广谱抗生素/升压/CRRT/镇静/血制品等）one-hot 或多热；
    - `nursing`：量表分数及阈超标记；
    - `history/exam`：概念抽取（疾病/症状/影像关键词），可选 UMLS 标准化（`core/umls`）。
  - 时间与缺失：
    - 显式加入每条事件的 `Δt`、时间位置编码（Time2Vec/分桶编码）；
    - 缺失掩码、上次观测时间（GRU-D 风格）。
- **4.3 切分与缓存**：
  - 按患者划分 dev/val/test，避免泄漏；
  - 预计算并缓存事件向量与解析结果（DuckDB/Parquet），加速迭代；
  - 类别不平衡通过重采样或损失加权处理。

### 5. 模型架构（建议与备选）

- **5.1 Baseline：GRU-D / T-LSTM（不规则时间友好）**
  - 输入：序列化的事件嵌入 + 结构特征 + 掩码 + Δt；
  - 机制：时间衰减门控（GRU-D）或时间感知门控（T-LSTM），缓解不规则间隔影响；
  - 输出头：多风险的 `sigmoid` 概率 `p_state(r|t)∈(0,1)`（当前/临近状态概率曲线）。

- **5.2 Time-aware Transformer（相对/连续时间编码）**
  - 将相对时间差编码为可学习嵌入（分桶）或 Time2Vec，与 RoPE/相对位置 Attention 融合；
  - 对长上下文的 TopK 事件做稀疏注意力或窗口注意力；
  - 适合作为中长期（3d/7d）预测增强的主干，可与 6h/24h 的 RNN 分支组成多分支网络。

- **5.3 多任务/多视角头**
  - 多风险共享骨干，不同风险/系统可加小型特定头；
  - 时间一致性与形状约束：
    - 向前单调性（`t≤onset_ts` 区间靠近 onset 的时刻预测不低于更早时刻）。
    - 向后单调衰减（`onset_ts<t<off_ts` 区间内随时间递减）。
    - 可采用排序正则/差分惩罚或在推理端用 EMA/迟滞稳定输出。

- **5.4 损失与校准**
  - 损失：对 `y_r^state(t)∈[0,1]` 使用 BCE with soft labels 或 MSE（经验上 BCE 更稳）；可按靠近 `onset_ts` 的样本给予更高权重（时间接近度加权）。
  - 蒸馏（可选）：引入 LLM 置信度或证据强度作为样本权重/软目标。
  - 校准：温度缩放或等值回归（isotonic）在验证集上拟合，以获得可解释的概率刻度。
  - 阈值：按 dev 上的 PR 曲线或告警成本函数确定 per-risk 的触发阈值（不再区分提前量）。

### 6. 训练流程（建议）

1) 预处理：
   - 解析 `icu_patients`，构建事件表与特征缓存；
   - 运行 LLM 标注（对高价值事件），汇总 `onset_ts/off_ts`；
   - 生成样本（窗口、特征、`y_r^state(t)` 软标签）。
2) 训练：
   - 采样策略：覆盖 `t≤onset_ts`（提前上升段）与 `onset_ts<t<off_ts`（后续下降段）；远离风险段可下采样。
   - 早停：监控 macro-AUPRC（将 `p_state` 二值化后）与 Brier；
   - 约束：加入轻量的时间排序/差分正则或在推理端做 EMA/迟滞稳定化。
3) 校准与选阈：
   - 在 val 上拟合温度/等值回归；
   - 选择 per-risk 的阈值，导出到配置，并记录阈上提前时间分布。
4) 导出：
   - 序列化模型权重、特征规范、标准化参数与校准器；
   - 记录版本号与风险词表快照。

### 7. 评估指标与分析

- 判别：AUC/AUPRC（将 `p_state` 与阈值比较得到二值），macro 与 per-risk。
- 校准：Brier、Reliability 曲线与 ECE（以 `y_state` 为软标签评估或用二值化版本评估）。
- 早预警：在阈值下首次触发到 `onset_ts` 的提前时间分布（分位数、均值）。
- 工作点：在固定告警率下的召回（或在固定召回下的告警率）。
- 消融：去除文本嵌入/结构特征/时间编码/单调正则/校准的影响。
- 一致性：LLM 教师 vs 学生模型的对齐度（KL/RankCorr）。

### 8. 在线推理与系统集成（要点）

- 与 `ICUMemoryAgent` 集成：在线维护最近 W 小时的事件窗口与特征缓存，按新事件增量更新；
- 与 Gating 协作：重要事件到达时优先执行推理；非重要事件采用节流与批处理；
- 与数值层衔接：对模型概率做 EMA/限幅/迟滞，与 `ICU_RISK_AGENT.md` 一致（输出为 `p_state`，不区分提前量）；
- 日志（英文）：记录输入窗口摘要、输出概率、超阈变更与引用证据 `event_id`。

### 9. 风险、偏差与合规

- 弱标注偏差：LLM 标注可能受提示词与筛选策略影响；通过医生复核与主动学习减轻。
- 数据漂移：不同时期/科室/文书模板变化导致分布漂移，需要定期重训或校准更新。
- 解释与可追溯：保留证据 `event_id`、onset 推导过程与模型版本；避免输出敏感全文。

### 10. 路线图（里程碑）

1) v0：LLM 标注 + Baseline（GRU-D/T-LSTM），支持 24h/3d/7d，基本校准与阈值。
2) v1：加入结构化解析（lab/order/nursing）与 UMLS 标准化；Time-aware Transformer；多分支融合。
3) v2：主动学习闭环（不确定样本优先医生复核）、跨患者 CBR 原型先验（提升早期召回）。

### 11. 附录：建议的 JSON Schema

- 事件级标注（LLM 输出）：
```json
{
  "event_id": "string",
  "present": [
    {"risk_path": "string", "confidence": "high|medium|low", "evidence_event_ids": ["string"], "rationale": "string"}
  ],
  "uncertain": [
    {"risk_path": "string", "confidence": "low", "evidence_event_ids": ["string"], "rationale": "string"}
  ]
}
```

- 训练样本（单个时间点 t）：
```json
{
  "patient_id": "string",
  "t_event_id": "string",
  "t_timestamp": "ISO8601",
  "features": {
    "events_window": [
      {"event_id": "string", "delta_minutes": 15, "type": "order", "sub_type": "...", "text_vec": [0.1, ...], "lab": {"K": 3.2, "K_flag": "low"}, "order_classes": {"vasopressor": 1, "antibiotic_broad": 0}, "scores": {"MEWS": 4}}
    ],
    "global": {"age": 70, "sex": "F"}
  },
  "labels": {
    "Sepsis": {"state_prob": 0.42},
    "AKI": {"state_prob": 0.00}
  }
}
```

---

以上方案可直接指导数据处理、弱标注、样本构建与模型训练的工程落地，并与现有 `ICU_RISK_AGENT.md` 的在线推理与数值层保持一致（多提前量概率、单调约束、EMA/迟滞与 Gating 协作）。


